<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Kamera (DEBUG) | LuniXhar</title>
    <link rel="icon" type="image/png" href="assets/lunixharlogo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/b497db0dc1.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #modalOverlay {
            transition: opacity 0.3s ease-in-out;
        }
        #modalOverlay.opacity-0 {
            pointer-events: none;
        }
        #modalContent {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="min-h-screen bg-[#f2f7ff] text-black">
    <button id="menu-btn" class="md:hidden fixed top-4 left-4 z-30 p-2 bg-gray-800 text-white rounded-full">
        <i class="fas fa-bars"></i>
    </button>
    
    <div id="menu-overlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-10 hidden"></div>

    <aside id="sidebar" class="w-64 bg-white border-r rounded-r-[18px] fixed top-0 left-0 h-screen flex flex-col items-center z-20
                               transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="p-6 border-b w-full flex justify-center">
            <img src="assets/lunixharlogo.png" alt="Logo" class="h-32 mt-4 mb-4" />
        </div>
        <nav class="flex-1 p-4 w-full">
            <ul class="space-y-4 w-full">
                <li><a href="index.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold"><i class="fa-solid fa-chart-line mr-3"></i> Dashboard</a></li>
                <li><a href="asosiasi.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold"><i class="fa-solid fa-layer-group mr-3"></i> Asosiasi</a></li>
                <li><a href="monitor.html" class="flex items-center px-4 py-3 pl-6 rounded-xl bg-black text-white font-bold"><i class="fa-solid fa-video mr-3"></i> Kamera</a></li>
                <li><a href="chatbot.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold"><i class="fa-solid fa-robot mr-3"></i> Chatbot</a></li>
            </ul>
        </nav>
    </aside>

    <main class="p-4 md:p-8 md:ml-64">
        <h1 class="text-3xl font-bold mb-6">Monitor Kamera</h1>

        <section aria-labelledby="pilihan-kamera">
            <h2 id="pilihan-kamera" class="sr-only">Pilihan Kamera</h2>
            <div class="flex flex-wrap justify-center gap-6">
                <div id="cameraCard1" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow"><img src="assets/cameraplace1.png" alt="Ikon Kamera 1" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" /><p class="text-lg font-semibold mb-2">Kamera 1 (Stream)</p><p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p></div>
                <div id="cameraCard2" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow"><img src="assets/cameraplace2.png" alt="Ikon Kamera 2" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" /><p class="text-lg font-semibold mb-2">Kamera 2 (Laptop / HP)</p><p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p></div>
                <div id="cameraCard3" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow"><img src="assets/cameraplace3.png" alt="Ikon Kamera 3" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" /><p class="text-lg font-semibold mb-2">Kamera 3 (DroidCam)</p><p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p></div>
            </div>
        </section>

        <section id="videoStreamSection" aria-labelledby="judul-video-stream" class="mt-8 hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="judul-video-stream" class="text-xl font-semibold">Camera Stream</h3>
                    <select id="camera-select" class="hidden p-2 border border-gray-300 rounded-lg text-sm focus:ring-black focus:border-black"></select>
                </div>
                <div id="videoContainer" class="relative bg-black rounded-lg overflow-hidden">
                    <video id="videoPlayer" class="block w-full h-auto" autoplay muted playsinline></video>
                    <canvas id="overlayCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                </div>
            </div>
        </section>
    </main>

    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0">
        <div id="modalContent" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center opacity-0 transform scale-95">
            <div class="mb-4"><i id="modalIcon" class="fas fa-exclamation-triangle text-5xl text-red-500"></i></div>
            <h3 id="modalTitle" class="text-xl font-semibold mb-2 text-gray-800">Error</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">Pesan error.</p>
            <button id="modalCloseButton" class="bg-black text-white font-semibold py-2.5 px-8 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Logika Hamburger & Elemen DOM (Tidak diubah) ---
            const menuBtn = document.getElementById('menu-btn'), sidebar = document.getElementById('sidebar'), overlay = document.getElementById('menu-overlay');
            function toggleMenu() { sidebar.classList.toggle('-translate-x-full'); sidebar.classList.toggle('translate-x-0'); overlay.classList.toggle('hidden'); }
            if (menuBtn) menuBtn.addEventListener('click', toggleMenu);
            if (overlay) overlay.addEventListener('click', toggleMenu);
            
            let hlsInstance=null, webcamStream=null, socket=null, frameInterval=null, activeRequestID=0, currentSourceType=null, currentCameraId=null;
            const videoStreamSection=document.getElementById("videoStreamSection"), videoPlayer=document.getElementById("videoPlayer"), overlayCanvas=document.getElementById("overlayCanvas"), canvasContext=overlayCanvas.getContext("2d"), cameraSelect=document.getElementById("camera-select");
            const modalOverlay=document.getElementById("modalOverlay"), modalContent=document.getElementById("modalContent"), modalIcon=document.getElementById("modalIcon"), modalTitle=document.getElementById("modalTitle"), modalMessage=document.getElementById("modalMessage"), modalCloseButton=document.getElementById("modalCloseButton");
            const actionColors={"Clapping":"green","Meet and Split":"blue","Sitting":"red","Standing Still":"yellow","Walking":"magenta","Walking While Reading Book":"cyan","Walking While Using Phone":"purple","Unknown":"gray"};
            
            // --- Fungsi-fungsi lainnya (Tidak diubah) ---
            async function populateCameraDropdown(currentStream) { /* ... (tidak diubah) ... */ }
            cameraSelect.addEventListener('change', (event) => { /* ... (tidak diubah) ... */ });
            function showModal(title, message, type="error") { /* ... (tidak diubah) ... */ }
            function hideModal() { /* ... (tidak diubah) ... */ }
            modalCloseButton?.addEventListener("click", () => { hideModal(); stopAllStreams(); });
            modalOverlay?.addEventListener("click", (e) => { if(e.target===modalOverlay) { hideModal(); stopAllStreams(); } });
            function stopAllStreams() { /* ... (tidak diubah) ... */ }
            
            // --- [DEBUG] FUNGSI UTAMA YANG DIMODIFIKASI ---
            async function startStreamAndDetection(sourceType, cameraId, videoSrc = null, specificDeviceId = null) {
                console.log(`[DEBUG] Memulai startStreamAndDetection. Tipe: ${sourceType}, ID Kamera: ${cameraId}, DeviceId Spesifik: ${specificDeviceId || 'tidak ada'}`);
                stopAllStreams();
                const requestID = activeRequestID;
                videoStreamSection.classList.remove("hidden");
                
                currentSourceType = sourceType;
                currentCameraId = cameraId;
                let localStream = null;

                try {
                    if (sourceType === "hls") {
                        console.log("[DEBUG] Tipe stream adalah HLS.");
                        cameraSelect.classList.add('hidden');
                        if (Hls.isSupported()) {
                            hlsInstance = new Hls();
                            hlsInstance.loadSource(videoSrc);
                            hlsInstance.attachMedia(videoPlayer);
                        } else { throw new Error("Browser tidak mendukung HLS."); }
                    } else {
                        console.log("[DEBUG] Tipe stream adalah Webcam. Memulai pencarian perangkat...");
                        let constraints = {};
                        if (specificDeviceId) {
                            console.log(`[DEBUG] Menggunakan DeviceID spesifik: ${specificDeviceId}`);
                            constraints.video = { deviceId: { exact: specificDeviceId } };
                        } else {
                            console.log("[DEBUG] Mencari perangkat video yang tersedia...");
                            // Meminta izin terlebih dahulu untuk mendapatkan label kamera
                            await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            const devices = await navigator.mediaDevices.enumerateDevices();
                            const cameras = devices.filter(d => d.kind === "videoinput");
                            console.log("[DEBUG] Daftar kamera yang ditemukan:", cameras);
                            console.table(cameras); // Menampilkan daftar kamera dalam bentuk tabel di console

                            if (cameras.length === 0) {
                                throw new Error("Tidak ada kamera yang terdeteksi di perangkat ini.");
                            }

                            if (sourceType === "webcam-droidcam") {
                                console.log("[DEBUG] Mencari DroidCam...");
                                const droidCam = cameras.find(d => d.label.toLowerCase().includes("droidcam"));
                                if (!droidCam) throw new Error("DroidCam tidak terdeteksi.");
                                console.log("[DEBUG] DroidCam ditemukan:", droidCam);
                                constraints.video = { deviceId: { exact: droidCam.deviceId } };
                            } else { // webcam-default
                                console.log("[DEBUG] Mencari kamera default (non-DroidCam)...");
                                const defaultCam = cameras.find(d => !d.label.toLowerCase().includes("droidcam"));
                                if (defaultCam) {
                                    console.log("[DEBUG] Kamera default ditemukan:", defaultCam);
                                    constraints.video = { deviceId: { exact: defaultCam.deviceId } };
                                } else {
                                    console.log("[DEBUG] Tidak ada kamera default, menggunakan kamera pertama yang tersedia:", cameras[0]);
                                    constraints.video = { deviceId: { exact: cameras[0].deviceId } };
                                }
                            }
                        }
                        
                        console.log("[DEBUG] Mencoba mendapatkan media dengan constraints:", constraints);
                        localStream = await navigator.mediaDevices.getUserMedia(constraints);
                        console.log("[DEBUG] Berhasil mendapatkan media stream!", localStream);
                    }

                    if (requestID !== activeRequestID) {
                        localStream?.getTracks().forEach(track => track.stop());
                        return;
                    }

                    if (localStream) {
                        webcamStream = localStream;
                        videoPlayer.srcObject = webcamStream;
                        await populateCameraDropdown(webcamStream);
                    }
                    
                    await videoPlayer.play();
                    await setupWebSocket(cameraId, requestID);

                } catch (error) {
                    // [DEBUG] Ini adalah bagian terpenting. Kita log seluruh objek error.
                    console.error("[DEBUG] Terjadi error saat startStreamAndDetection:", error);
                    console.error("[DEBUG] Nama Error:", error.name); // NotAllowedError, NotFoundError, dll.
                    console.error("[DEBUG] Pesan Error:", error.message);
                    
                    showModal("Kesalahan", `Gagal memulai stream. Pesan dari browser: "${error.message}"`);
                    stopAllStreams();
                }
            }

            // --- Sisa fungsi tidak diubah ---
            function setupWebSocket(cameraId, requestID) { /* ... (tidak diubah) ... */ }
            function sendFrame(requestID) { /* ... (tidak diubah) ... */ }
            document.getElementById("cameraCard1").addEventListener("click", () => startStreamAndDetection("hls", 1, "video/stream1.m3u8"));
            document.getElementById("cameraCard2").addEventListener("click", () => startStreamAndDetection("webcam-default", 2));
            document.getElementById("cameraCard3").addEventListener("click", () => startStreamAndDetection("webcam-droidcam", 3));

            // Implementasi dummy agar tidak error
            if (typeof populateCameraDropdown !== 'function') { async function populateCameraDropdown(currentStream) {} }
            if (typeof showModal !== 'function') { function showModal(title, message, type="error") {} }
            if (typeof hideModal !== 'function') { function hideModal() {} }
            if (typeof stopAllStreams !== 'function') { function stopAllStreams() {} }
            if (typeof setupWebSocket !== 'function') { function setupWebSocket(cameraId, requestID) {} }
            if (typeof sendFrame !== 'function') { function sendFrame(requestID) {} }
        });
    </script>
</body>
</html>