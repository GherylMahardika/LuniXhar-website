<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor Kamera | LuniXhar</title>
    <link rel="icon" type="image/png" href="assets/lunixharlogo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/b497db0dc1.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #modalOverlay {
            transition: opacity 0.3s ease-in-out;
        }
        #modalOverlay.opacity-0 {
            pointer-events: none;
        }
        #modalContent {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="flex min-h-screen bg-[#f2f7ff] text-black">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r rounded-tr-[18px] rounded-br-[18px] fixed top-0 left-0 h-screen flex flex-col items-center z-10">
        <div class="p-6 border-b w-full flex justify-center">
            <img src="assets/lunixharlogo.png" alt="Logo" class="h-32 mt-4 mb-4" />
        </div>
        <nav class="flex-1 p-4 w-full">
            <ul class="space-y-4 w-full">
                <li>
                    <a href="index.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold">
                        <i class="fa-solid fa-chart-line mr-3"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="asosiasi.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold">
                        <i class="fa-solid fa-layer-group mr-3"></i> Asosiasi
                    </a>
                </li>
                <li>
                    <a href="monitor.html" class="flex items-center px-4 py-3 pl-6 rounded-xl bg-black text-white font-bold">
                        <i class="fa-solid fa-video mr-3"></i> Kamera
                    </a>
                </li>
                <li>
                    <a href="chatbot.html" class="flex items-center px-4 py-3 pl-6 rounded-xl hover:bg-gray-200 text-black font-bold">
                        <i class="fa-solid fa-robot mr-3"></i> Chatbot
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 flex-1 p-8">
        <h1 class="text-3xl font-bold mb-6">Monitor Kamera</h1>

        <!-- Pilihan Kamera -->
        <section aria-labelledby="pilihan-kamera">
            <h2 id="pilihan-kamera" class="sr-only">Pilihan Kamera</h2>
            <div class="flex flex-wrap justify-center gap-6">
                <!-- Card 1 -->
                <div id="cameraCard1" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow">
                    <img src="assets/cameraplace1.png" alt="Ikon Kamera 1" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" />
                    <p class="text-lg font-semibold mb-2">Kamera 1 (Stream)</p>
                    <p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p>
                </div>

                <!-- Card 2 -->
                <div id="cameraCard2" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow">
                    <img src="assets/cameraplace2.png" alt="Ikon Kamera 2" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" />
                    <p class="text-lg font-semibold mb-2">Kamera 2 (Laptop / HP)</p>
                    <p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p>
                </div>

                <!-- Card 3 -->
                <div id="cameraCard3" class="camera-card bg-white rounded-xl shadow p-6 flex flex-col items-center w-full sm:w-auto md:w-80 flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow">
                    <img src="assets/cameraplace3.png" alt="Ikon Kamera 3" class="w-28 h-28 rounded-full object-cover mb-4 border-4 border-gray-200" />
                    <p class="text-lg font-semibold mb-2">Kamera 3 (DroidCam)</p>
                    <p class="text-sm font-bold text-white bg-green-600 rounded-full px-3 py-1">Online</p>
                </div>
            </div>
        </section>

        <!-- Tampilan Video Stream dengan Deteksi -->
        <section id="videoStreamSection" aria-labelledby="judul-video-stream" class="mt-8 hidden">
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 id="judul-video-stream" class="text-xl font-semibold mb-4">Camera Stream</h3>
                <div id="videoContainer" class="relative bg-black rounded-lg overflow-hidden">
                    <video id="videoPlayer" class="block w-full h-auto" autoplay muted playsinline></video>
                    <canvas id="overlayCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Overlay untuk Notifikasi -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 opacity-0">
        <div id="modalContent" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center opacity-0 transform scale-95">
            <div class="mb-4">
                <i id="modalIcon" class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
            </div>
            <h3 id="modalTitle" class="text-xl font-semibold mb-2 text-gray-800">Error</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">Pesan error.</p>
            <button id="modalCloseButton" class="bg-black text-white font-semibold py-2.5 px-8 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700">OK</button>
        </div>
    </div>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let hlsInstance = null;
            let webcamStream = null;
            let socket = null;
            let frameInterval = null;
            let activeRequestID = 0;

            const videoStreamSection = document.getElementById("videoStreamSection");
            const videoPlayer = document.getElementById("videoPlayer");
            const overlayCanvas = document.getElementById("overlayCanvas");
            const canvasContext = overlayCanvas.getContext("2d");

            const modalOverlay = document.getElementById("modalOverlay");
            const modalContent = document.getElementById("modalContent");
            const modalIcon = document.getElementById("modalIcon");
            const modalTitle = document.getElementById("modalTitle");
            const modalMessage = document.getElementById("modalMessage");
            const modalCloseButton = document.getElementById("modalCloseButton");

            const actionColors = {
                "Clapping": "green", "Meet and Split": "blue", "Sitting": "red",
                "Standing Still": "yellow", "Walking": "magenta", 
                "Walking While Reading Book": "cyan", "Walking While Using Phone": "purple",
                "Unknown": "gray"
            };

            function showModal(title, message, type = "error") {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalIcon.className = "fas text-5xl mb-4";
                modalTitle.className = "text-xl font-semibold mb-2";

                if (type === "error") {
                    modalIcon.classList.add("fa-times-circle", "text-red-500");
                    modalTitle.classList.add("text-red-600");
                } else {
                    modalIcon.classList.add("fa-info-circle", "text-blue-500");
                    modalTitle.classList.add("text-blue-600");
                }
                modalOverlay.classList.remove("hidden");
                requestAnimationFrame(() => {
                    modalOverlay.classList.remove("opacity-0");
                    modalContent.classList.remove("opacity-0", "scale-95");
                    modalContent.classList.add("opacity-100", "scale-100");
                });
            }

            function hideModal() {
                modalOverlay.classList.add("opacity-0");
                modalContent.classList.remove("opacity-100", "scale-100");
                modalContent.classList.add("opacity-0", "scale-95");
                const onTransitionEnd = (e) => {
                    if (e.target === modalOverlay) {
                        modalOverlay.classList.add("hidden");
                        modalOverlay.removeEventListener("transitionend", onTransitionEnd);
                    }
                };
                modalOverlay.addEventListener("transitionend", onTransitionEnd);
            }

            modalCloseButton?.addEventListener("click", () => {
                hideModal();
                stopAllStreams();
            });
            modalOverlay?.addEventListener("click", (e) => {
                if (e.target === modalOverlay) {
                    hideModal();
                    stopAllStreams();
                }
            });

            function stopAllStreams() {
                activeRequestID++;
                if (hlsInstance) hlsInstance.destroy();
                if (webcamStream) webcamStream.getTracks().forEach(track => track.stop());
                if (frameInterval) clearInterval(frameInterval);
                if (socket && socket.readyState !== WebSocket.CLOSED) socket.close();
                hlsInstance = webcamStream = socket = frameInterval = null;
                videoPlayer.pause();
                videoPlayer.removeAttribute("src");
                videoPlayer.srcObject = null;
                videoPlayer.load();
                canvasContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                videoStreamSection.classList.add("hidden");
            }

            async function startStreamAndDetection(sourceType, cameraId, videoSrc = null) {
                stopAllStreams();
                const requestID = activeRequestID;
                videoStreamSection.classList.remove("hidden");
                let localStream = null;

                try {
                    if (sourceType === "hls") {
                        if (Hls.isSupported()) {
                            hlsInstance = new Hls();
                            hlsInstance.loadSource(videoSrc);
                            hlsInstance.attachMedia(videoPlayer);
                        } else {
                            throw new Error("Browser tidak mendukung HLS.");
                        }
                    } else {
                        let constraints = {};
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const cameras = devices.filter(d => d.kind === "videoinput");

                        if (sourceType === "webcam-droidcam") {
                            const droidCam = cameras.find(d => d.label.toLowerCase().includes("droidcam"));
                            if (!droidCam) throw new Error("DroidCam tidak terdeteksi.");
                            constraints.video = { deviceId: { exact: droidCam.deviceId } };
                        } else { // webcam-default
                            const defaultCam = cameras.find(d => !d.label.toLowerCase().includes("droidcam"));
                            if (defaultCam) {
                                constraints.video = { deviceId: { exact: defaultCam.deviceId } };
                            } else {
                                constraints.video = { facingMode: "user" };
                            }
                        }
                        localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    if (requestID !== activeRequestID) {
                        localStream?.getTracks().forEach(track => track.stop());
                        return;
                    }

                    if (localStream) {
                        webcamStream = localStream;
                        videoPlayer.srcObject = webcamStream;
                    }
                    
                    await videoPlayer.play();
                    await setupWebSocket(cameraId, requestID);

                } catch (error) {
                    showModal("Kesalahan", error.message || "Gagal memulai stream.");
                }
            }

            function setupWebSocket(cameraId, requestID) {
                return new Promise((resolve, reject) => {
                    if (requestID !== activeRequestID) return reject(new Error("Permintaan usang."));

                    const ws = new WebSocket("wss://lunix-har-api-901050835625.asia-southeast2.run.app/ws");

                    ws.onopen = () => {
                        if (requestID !== activeRequestID) return ws.close();
                        ws.send(JSON.stringify({ camera_id: cameraId }));
                        socket = ws;
                        frameInterval = setInterval(() => sendFrame(requestID), 500);
                        resolve();
                    };

                    ws.onmessage = (event) => {
                        if (requestID !== activeRequestID) return;
                        try {
                            const data = JSON.parse(event.data);
                            const detections = data.detections;

                            overlayCanvas.width = videoPlayer.videoWidth;
                            overlayCanvas.height = videoPlayer.videoHeight;
                            canvasContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

                            if (Array.isArray(detections)) {
                                detections.forEach(det => {
                                    const [x1, y1, x2, y2] = det.bbox;
                                    const width = x2 - x1;
                                    const height = y2 - y1;
                                    
                                    const color = actionColors[det.label] || 'lime';

                                    canvasContext.strokeStyle = color;
                                    canvasContext.lineWidth = 2;
                                    canvasContext.strokeRect(x1, y1, width, height);
                                    
                                    const text = `#${det.person_id} ${det.label} (${(det.confidence * 100).toFixed(1)}%)`;
                                    canvasContext.font = "16px Arial";
                                    canvasContext.fillStyle = color;
                                    canvasContext.fillText(text, x1 + 4, y1 - 5);
                                });
                            }
                        } catch (e) {
                            console.error("Gagal memproses pesan:", e);
                        }
                    };

                    ws.onerror = (err) => {
                        console.error("WebSocket error:", err);
                        reject(new Error("Gagal terhubung ke server deteksi."));
                    };

                    ws.onclose = () => {
                        console.log(`WebSocket ditutup untuk permintaan #${requestID}`);
                        if (frameInterval) clearInterval(frameInterval);
                        if(requestID === activeRequestID) {
                            showModal("Terputus", "Koneksi ke server deteksi terputus.");
                        }
                    };
                });
            }

            function sendFrame(requestID) {
                if (!videoPlayer || !socket || socket.readyState !== WebSocket.OPEN || requestID !== activeRequestID) {
                    if(frameInterval) clearInterval(frameInterval);
                    return;
                }
                const tempCanvas = document.createElement("canvas");
                const ctx = tempCanvas.getContext("2d");
                tempCanvas.width = videoPlayer.videoWidth;
                tempCanvas.height = videoPlayer.videoHeight;
                ctx.drawImage(videoPlayer, 0, 0, tempCanvas.width, tempCanvas.height);
                tempCanvas.toBlob(blob => {
                    if (blob && requestID === activeRequestID) {
                        blob.arrayBuffer().then(buffer => {
                            if (socket && socket.readyState === WebSocket.OPEN) {
                                socket.send(buffer);
                            }
                        });
                    }
                }, 'image/jpeg');
            }

            document.getElementById("cameraCard1").addEventListener("click", () => startStreamAndDetection("hls", 1, "video/stream1.m3u8"));
            document.getElementById("cameraCard2").addEventListener("click", () => startStreamAndDetection("webcam-default", 2));
            document.getElementById("cameraCard3").addEventListener("click", () => startStreamAndDetection("webcam-droidcam", 3));
        });
    </script>
</body>
</html>
